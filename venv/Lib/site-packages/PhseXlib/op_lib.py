from PhseXlib.locals import * # type: ignore
from PhseXlib.addres import addres_transformer
from pathlib import Path
from sys import exit
import os
import json

# CONFIG = json.load(Path("build.json").open("r",encoding="utf-8"))

def op_write(data,addres:dict):
    """单比特写入"""
    with open(addres["file"],"r+",encoding="utf-8") as data_file:
        data_dict = json.load(data_file)
        data_dict[addres["key"]] = data
        data_file.seek(0)
        data_file.write(json.dumps(data_dict))
        data_file.truncate()

def op_stop_os(stop_message:str, exit_code:int):
    print(f"OS stopped.\nReason for stopping: {stop_message}\nExit code: {exit_code}")
    exit()

def op_data_transform(data, mode):
    if mode == CHAR_TO_BIN:
        encode_dict:dict = json.load(Path(os.path.join(CONFIG["STORAGE_dir"],"system","CharSet","PhseEncode.json")).open("r",encoding="utf-8"))
        
        if data in encode_dict.values():
            return next((k for k, v in encode_dict.items() if v == data), None)
        else:
            return f"{data} is not in default CharSet(PhseEncode.json)."
    elif mode == INT_TO_BIN:
        return f"{int(data) & 0xFF:08b}"

def op_wirte_block_to_memory(data_list:list):
    """多比特内存写入"""
    with open(CONFIG["RAM_file"],"r",encoding="utf-8") as memory_file:
        memory_dict:dict = json.load(memory_file)
        writed_block_list = []
        count = 0
        for i,j in memory_dict.items():
            if j == 0 and count != len(data_list):
                writed_block_list.append(i)
                count += 1
        
        for i,j in zip(writed_block_list,data_list):
            op_write(op_data_transform(j,CHAR_TO_BIN),addres_transformer(i))
