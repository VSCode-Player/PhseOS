from PhseXlib.locals import * # type: ignore
from pathlib import Path
from sys import exit
import os
import json

# CONFIG = json.load(Path("build.json").open("r",encoding="utf-8"))

def op_write(data,addres:dict):
    """单比特写入"""
    with open(addres["file"],"r+",encoding="utf-8") as data_file:
        data_dict = json.load(data_file)
        data_dict[addres["key"]] = data
        data_file.seek(0)
        data_file.write(json.dumps(data_dict))
        data_file.truncate()

def op_stop_os(stop_message:str, exit_code:int):
    print(f"OS stopped.\nReason for stopping: {stop_message}\nExit code: {exit_code}")
    exit()

def op_data_transform(data, mode, CharSet="PhseEncode.json"):
    if mode == CHAR_TO_BIN:
        encode_dict:dict = json.load(Path(os.path.join(CONFIG["STORAGE_dir"],"system","CharSet",CharSet)).open("r",encoding="utf-8"))
        
        if data in encode_dict.values():
            return next((k for k, v in encode_dict.items() if v == data), None)
        else:
            return f"{data} is not in default CharSet(PhseEncode.json)."
    elif mode == BIN_TO_CHAR:
        encode_dict:dict = json.load(Path(os.path.join(CONFIG["STORAGE_dir"],"system","CharSet",CharSet)).open("r",encoding="utf-8"))
        if data in encode_dict:
            return encode_dict[data]
        else:
            return f"{data} is not in default CharSet(PhseEncode.json)."
    elif mode == INT_TO_BIN:
        return f"{int(data) & 0xFF:08b}"
    elif mode == BIN_TO_INT:
        return int(data, 2)
    
def op_string_format(string):
    '''
    将字符串格式化
    
    :param string: 需要格式化的字符串
    :return: 格式化后的字符串
    '''
    for key, value in format_dict.items(): # format_dict在locals.py中定义
        string = string.replace(key, value)
    return string